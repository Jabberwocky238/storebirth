# Combinator K3s Deployment
# 无状态应用，5 个副本，尽可能分散部署

---
apiVersion: v1
kind: Namespace
metadata:
  name: combinator
  labels:
    name: combinator

---
# Combinator ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: combinator-config
  namespace: combinator
data:
  config.json: |
    {
      "rdb": [],
      "kv": []
    }

---
# Combinator Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: combinator
  namespace: combinator
spec:
  replicas: 5
  selector:
    matchLabels:
      app: combinator
  template:
    metadata:
      labels:
        app: combinator
    spec:
      # Pod 反亲和性配置 - 尽可能分散到不同节点
      affinity:
        podAntiAffinity:
          # 优先级调度：尽量不在同一节点
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - combinator
                topologyKey: kubernetes.io/hostname
          # 如果需要强制分散（节点数>=5时），可以取消下面的注释
          # requiredDuringSchedulingIgnoredDuringExecution:
          #   - labelSelector:
          #       matchExpressions:
          #         - key: app
          #           operator: In
          #           values:
          #             - combinator
          #     topologyKey: kubernetes.io/hostname
      containers:
      - name: combinator
        image: ghcr.io/jabberwocky238/combinator:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8899
          name: http
        - containerPort: 8890
          name: webhook
        args:
        - "start"
        - "-c"
        - "/config/config.json"
        - "-l"
        - "0.0.0.0:8899"
        volumeMounts:
        - name: config
          mountPath: /config
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8890
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 8899
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2
      volumes:
      - name: config
        configMap:
          name: combinator-config

---
# Combinator Service
apiVersion: v1
kind: Service
metadata:
  name: combinator
  namespace: combinator
spec:
  selector:
    app: combinator
  ports:
  - name: http
    port: 8899
    targetPort: 8899
  - name: webhook
    port: 8890
    targetPort: 8890
  type: ClusterIP
