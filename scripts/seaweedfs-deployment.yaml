# SeaweedFS 集群部署配置
# 支持多租户管理，最低配置 1C 2G
# 使用 Longhorn 分布式存储，支持节点故障转移
# 安装 Longhorn: kubectl apply -f https://raw.githubusercontent.com/longhorn/longhorn/master/deploy/longhorn.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: seaweedfs
  labels:
    name: seaweedfs

---
# Master Service
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-master
  namespace: seaweedfs
  labels:
    app: seaweedfs-master
spec:
  clusterIP: None
  ports:
    - name: master
      port: 9333
      targetPort: 9333
    - name: grpc
      port: 19333
      targetPort: 19333
  selector:
    app: seaweedfs-master

---
# Master StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: seaweedfs-master
  namespace: seaweedfs
spec:
  serviceName: seaweedfs-master
  replicas: 3
  selector:
    matchLabels:
      app: seaweedfs-master
  template:
    metadata:
      labels:
        app: seaweedfs-master
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - seaweedfs-master
                topologyKey: kubernetes.io/hostname
      containers:
        - name: seaweedfs-master
          image: chrislusf/seaweedfs:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9333
              name: master
            - containerPort: 19333
              name: grpc
          command:
            - "/usr/bin/weed"
            - "master"
            - "-ip=$(POD_IP)"
            - "-port=9333"
            - "-mdir=/data"
            - "-peers=seaweedfs-master-0.seaweedfs-master.seaweedfs:9333,seaweedfs-master-1.seaweedfs-master.seaweedfs:9333,seaweedfs-master-2.seaweedfs-master.seaweedfs:9333"
            - "-defaultReplication=001"
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          resources:
            requests:
              cpu: "1000m"
              memory: "2Gi"
            limits:
              cpu: "1000m"
              memory: "2Gi"
          volumeMounts:
            - name: data
              mountPath: /data
          livenessProbe:
            httpGet:
              path: /cluster/status
              port: 9333
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /cluster/status
              port: 9333
            initialDelaySeconds: 10
            periodSeconds: 5
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        storageClassName: local-path
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi

---
# Volume Service
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-volume
  namespace: seaweedfs
  labels:
    app: seaweedfs-volume
spec:
  clusterIP: None
  ports:
    - name: volume
      port: 8080
      targetPort: 8080
    - name: grpc
      port: 18080
      targetPort: 18080
  selector:
    app: seaweedfs-volume

---
# Volume StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: seaweedfs-volume
  namespace: seaweedfs
spec:
  serviceName: seaweedfs-volume
  replicas: 3
  selector:
    matchLabels:
      app: seaweedfs-volume
  template:
    metadata:
      labels:
        app: seaweedfs-volume
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - seaweedfs-volume
                topologyKey: kubernetes.io/hostname
      containers:
        - name: seaweedfs-volume
          image: chrislusf/seaweedfs:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
              name: volume
            - containerPort: 18080
              name: grpc
          command:
            - "/usr/bin/weed"
            - "volume"
            - "-ip=$(POD_IP)"
            - "-port=8080"
            - "-dir=/data"
            - "-max=100"
            - "-mserver=seaweedfs-master-0.seaweedfs-master.seaweedfs:9333,seaweedfs-master-1.seaweedfs-master.seaweedfs:9333,seaweedfs-master-2.seaweedfs-master.seaweedfs:9333"
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          resources:
            requests:
              cpu: "1000m"
              memory: "2Gi"
            limits:
              cpu: "1000m"
              memory: "2Gi"
          volumeMounts:
            - name: data
              mountPath: /data
          livenessProbe:
            httpGet:
              path: /status
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /status
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 100Gi

---
# Filer Service
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-filer
  namespace: seaweedfs
  labels:
    app: seaweedfs-filer
spec:
  type: ClusterIP
  ports:
    - name: filer
      port: 8888
      targetPort: 8888
    - name: grpc
      port: 18888
      targetPort: 18888
  selector:
    app: seaweedfs-filer

---
# Filer Deployment (支持多租户)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seaweedfs-filer
  namespace: seaweedfs
spec:
  replicas: 2
  selector:
    matchLabels:
      app: seaweedfs-filer
  template:
    metadata:
      labels:
        app: seaweedfs-filer
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - seaweedfs-filer
                topologyKey: kubernetes.io/hostname
      containers:
        - name: seaweedfs-filer
          image: chrislusf/seaweedfs:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8888
              name: filer
            - containerPort: 18888
              name: grpc
          command:
            - "/usr/bin/weed"
            - "filer"
            - "-ip=$(POD_IP)"
            - "-port=8888"
            - "-master=seaweedfs-master-0.seaweedfs-master.seaweedfs:9333,seaweedfs-master-1.seaweedfs-master.seaweedfs:9333,seaweedfs-master-2.seaweedfs-master.seaweedfs:9333"
            - "-defaultReplicaPlacement=001"
            - "-encryptVolumeData"
          env:
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          resources:
            requests:
              cpu: "1000m"
              memory: "2Gi"
            limits:
              cpu: "1000m"
              memory: "2Gi"
          volumeMounts:
            - name: filer-config
              mountPath: /etc/seaweedfs
          livenessProbe:
            httpGet:
              path: /
              port: 8888
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 8888
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: filer-config
          configMap:
            name: seaweedfs-filer-config

---
# Filer ConfigMap (JWT 动态多租户配置)
apiVersion: v1
kind: ConfigMap
metadata:
  name: seaweedfs-filer-config
  namespace: seaweedfs
data:
  filer.toml: |
    [leveldb2]
    enabled = true
    dir = "/data/filerldb2"

    # JWT 动态多租户配置
    # 使用 JWT 令牌控制访问权限，支持无限用户
    [jwt.signing]
    key = "your-secret-key-change-this-in-production"
    expires_after_seconds = 86400

    [jwt.signing.read]
    key = "your-read-key-change-this-in-production"
    expires_after_seconds = 86400

    [jwt.signing.write]
    key = "your-write-key-change-this-in-production"
    expires_after_seconds = 86400

---
# S3 Gateway Service (多租户访问)
apiVersion: v1
kind: Service
metadata:
  name: seaweedfs-s3
  namespace: seaweedfs
  labels:
    app: seaweedfs-s3
spec:
  type: ClusterIP
  ports:
    - name: s3
      port: 8333
      targetPort: 8333
  selector:
    app: seaweedfs-s3

---
# S3 Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seaweedfs-s3
  namespace: seaweedfs
spec:
  replicas: 2
  selector:
    matchLabels:
      app: seaweedfs-s3
  template:
    metadata:
      labels:
        app: seaweedfs-s3
    spec:
      containers:
        - name: seaweedfs-s3
          image: chrislusf/seaweedfs:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8333
              name: s3
          command:
            - "/usr/bin/weed"
            - "s3"
            - "-port=8333"
            - "-filer=seaweedfs-filer:8888"
            - "-config=/etc/seaweedfs/s3.json"
          resources:
            requests:
              cpu: "1000m"
              memory: "2Gi"
            limits:
              cpu: "1000m"
              memory: "2Gi"
          volumeMounts:
            - name: s3-config
              mountPath: /etc/seaweedfs
          livenessProbe:
            httpGet:
              path: /
              port: 8333
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 8333
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: s3-config
          configMap:
            name: seaweedfs-s3-config

---
# S3 ConfigMap (动态多租户 - 使用外部认证)
apiVersion: v1
kind: ConfigMap
metadata:
  name: seaweedfs-s3-config
  namespace: seaweedfs
data:
  s3.json: |
    {
      "identities": [
        {
          "name": "admin",
          "credentials": [
            {
              "accessKey": "admin_access_key",
              "secretKey": "admin_secret_key_change_this"
            }
          ],
          "actions": [
            "Admin",
            "Read",
            "Write",
            "List",
            "Tagging"
          ]
        }
      ]
    }
