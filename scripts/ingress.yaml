# ============================================
# Ingress 配置 (统一管理所有路由规则)
# ============================================
# 使用方法:
# export DOMAIN=example.com
# envsubst < ingress.yaml | kubectl apply -f -
#
# 注意: 需要先部署 k3s-deployment.yaml 创建服务
# ============================================
---
apiVersion: v1
kind: Namespace
metadata:
  name: ingress
# ============================================
# Traefik 配置 (允许 ExternalName Services)
# ============================================
---
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    providers:
      kubernetesIngress:
        allowExternalNameServices: true
      kubernetesCRD:
        allowExternalNameServices: true
        allowCrossNamespace: true
---
# Console 证书
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: console-cert
  namespace: ingress
spec:
  secretName: console-tls
  issuerRef:
    name: zerossl-prod
    kind: ClusterIssuer
  dnsNames:
    - console.${DOMAIN}
---
# Worker 证书
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: worker-cert
  namespace: ingress
spec:
  secretName: worker-tls
  issuerRef:
    name: zerossl-prod
    kind: ClusterIssuer
  dnsNames:
    - "*.worker.${DOMAIN}"
---
# Combinator 证书
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: combinator-cert
  namespace: ingress
spec:
  secretName: combinator-tls
  issuerRef:
    name: zerossl-prod
    kind: ClusterIssuer
  dnsNames:
    - combinator.${DOMAIN}
---
# Console IngressRoute (跨 namespace 引用 console namespace 的 control-plane service)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: console
  namespace: ingress
spec:
  entryPoints:
    - websecure
  routes:
    - match: "Host(`console.${DOMAIN}`)"
      kind: Rule
      services:
        - name: control-plane-outer
          namespace: console
          port: 9900
  tls:
    secretName: console-tls
---
# Console IngressRoute (跨 namespace 引用 console namespace 的 control-plane service)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: combinator
  namespace: ingress
spec:
  entryPoints:
    - websecure
  routes:
    - match: "Host(`combinator.${DOMAIN}`)"
      kind: Rule
      services:
        - name: combinator
          namespace: combinator
          port: 8899
  tls:
    secretName: combinator-tls

