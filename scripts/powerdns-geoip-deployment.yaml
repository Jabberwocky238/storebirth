---
# PowerDNS + GeoIP 分流部署配置
#
# 架构说明：
# 1. PowerDNS 根据用户地理位置返回不同地区集群的入口 IP
# 2. 用户访问 *.mesh-worker.com 时，DNS 解析到对应地区的 K3s 集群入口
# 3. Traefik IngressRoute 根据 Host 头将流量路由到 console/control-plane-outer 服务
#
# 需要从官网获取的资源：
# 1. MaxMind GeoLite2 数据库
#    - 官网: https://www.maxmind.com/en/geolite2/signup
#    - 或使用公共镜像源（第 195-197 行，已配置）
#
# 需要自定义配置的部分：
# 1. 集群入口 IP 地址 (第 67-73 行)
#    - HK_IP: 香港/中国/台湾/澳门地区集群入口 IP (当前: 101.32.181.225)
#    - US_IP: 美国/加拿大地区集群入口 IP (当前: 170.106.143.75)
#    - MY_IP: 马来西亚/东南亚地区集群入口 IP (当前: 170.106.143.75)
#    - DEFAULT_IP: 其他地区默认集群入口 IP (当前: 163.245.215.17)
#    注意: 这些 IP 是 K3s LoadBalancer Service 或节点 IP，不是 Pod IP
#
# 2. 域名配置 (第 100 行)
#    - 当前配置: *.mesh-worker.com 和 mesh-worker.com
#    - 修改为你的实际域名
#
# 3. PowerDNS API Key (第 58、237 行)
#    - 默认: changeme-api-key
#    - 建议修改为强密码
#
---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: powerdns-system

---
# ConfigMap for PowerDNS configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: powerdns-config
  namespace: powerdns-system
data:
  pdns.conf: |
    launch=pipe
    pipe-command=/usr/local/bin/geoip-backend.sh
    local-address=0.0.0.0
    local-port=53
    log-dns-queries=yes
    loglevel=6
    webserver=yes
    webserver-address=0.0.0.0
    webserver-port=8081
    webserver-allow-from=0.0.0.0/0
    api=yes
    api-key=changeme-api-key

  geoip-backend.sh: |
    #!/bin/bash
    # PowerDNS Pipe Backend with GeoIP support

    GEOIP_DB="/geoip/GeoLite2-Country.mmdb"

    # 香港IP
    HK_IP="101.32.181.225"
    # 美国IP
    US_IP="170.106.143.75"
    # 马来西亚IP
    MY_IP="170.106.143.75"
    # 默认IP（其他地区）
    DEFAULT_IP="163.245.215.17"

    handshake() {
      read -r HELLO
      if [ "$HELLO" = "HELO\t1" ] || [ "$HELLO" = "HELO	1" ]; then
        echo "OK	PowerDNS GeoIP Backend"
      fi
    }

    get_country_from_ip() {
      local ip=$1
      if [ -f "$GEOIP_DB" ]; then
        country=$(mmdblookup --file "$GEOIP_DB" --ip "$ip" country iso_code 2>/dev/null | grep -oP '"\K[^"]+' | head -1)
        echo "$country"
      else
        echo "US"
      fi
    }

    query() {
      local qname=$1
      local qclass=$2
      local qtype=$3
      local id=$4
      local remote_ip=$5

      # 匹配 *.mesh-worker.com 泛域名
      if [ "$qtype" = "A" ] && [[ "$qname" =~ \.mesh-worker\.com$ || "$qname" = "mesh-worker.com" ]]; then
        country=$(get_country_from_ip "$remote_ip")

        case "$country" in
          HK|CN|TW|MO)
            target_ip="$HK_IP"
            ;;
          US|CA)
            target_ip="$US_IP"
            ;;
          MY|SG|ID|TH|VN|PH)
            target_ip="$MY_IP"
            ;;
          *)
            target_ip="$DEFAULT_IP"
            ;;
        esac

        echo "DATA	$qname	$qclass	$qtype	300	$id	$target_ip"
      fi

      echo "END"
    }

    handshake

    while read -r line; do
      IFS=$'\t' read -ra PARTS <<< "$line"
      cmd="${PARTS[0]}"

      case "$cmd" in
        Q)
          qname="${PARTS[1]}"
          qclass="${PARTS[2]}"
          qtype="${PARTS[3]}"
          id="${PARTS[4]}"
          remote_ip="${PARTS[5]}"
          query "$qname" "$qclass" "$qtype" "$id" "$remote_ip"
          ;;
        AXFR)
          echo "END"
          ;;
        *)
          echo "FAIL"
          ;;
      esac
    done

---
# PersistentVolumeClaim for GeoIP database
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: geoip-data
  namespace: powerdns-system
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: powerdns
  namespace: powerdns-system
  labels:
    app: powerdns
spec:
  replicas: 2
  selector:
    matchLabels:
      app: powerdns
  template:
    metadata:
      labels:
        app: powerdns
    spec:
      initContainers:
      - name: download-geoip
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          set -e
          echo "Downloading GeoLite2-Country database..."

          if [ ! -f /geoip/GeoLite2-Country.mmdb ]; then
            # 从公共镜像下载 GeoLite2 数据库
            curl -L "https://git.io/GeoLite2-Country.mmdb" -o /geoip/GeoLite2-Country.mmdb || \
            curl -L "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb" -o /geoip/GeoLite2-Country.mmdb

            echo "GeoIP database downloaded successfully"
          else
            echo "GeoIP database already exists"
          fi
        volumeMounts:
        - name: geoip-data
          mountPath: /geoip

      containers:
      - name: powerdns
        image: powerdns/pdns-auth-48:latest
        ports:
        - containerPort: 53
          protocol: UDP
          name: dns-udp
        - containerPort: 53
          protocol: TCP
          name: dns-tcp
        - containerPort: 8081
          protocol: TCP
          name: api
        env:
        - name: PDNS_AUTH_API_KEY
          value: "changeme-api-key"
        volumeMounts:
        - name: config
          mountPath: /etc/powerdns/pdns.conf
          subPath: pdns.conf
        - name: geoip-backend-script
          mountPath: /usr/local/bin/geoip-backend.sh
          subPath: geoip-backend.sh
        - name: geoip-data
          mountPath: /geoip
        command:
        - sh
        - -c
        - |
          set -e

          # 安装必要的工具 (Debian 系统使用 apt)
          echo "Installing dependencies..."
          apt-get update -qq
          apt-get install -y -qq libmaxminddb0 libmaxminddb-dev mmdb-bin

          # 测试 GeoIP 数据库
          if [ ! -f /geoip/GeoLite2-Country.mmdb ]; then
            echo "ERROR: GeoIP database not found"
            exit 1
          fi

          echo "Starting PowerDNS..."
          exec /usr/local/sbin/pdns_server --config-dir=/etc/powerdns --daemon=no
        livenessProbe:
          tcpSocket:
            port: 53
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 53
          initialDelaySeconds: 10
          periodSeconds: 5
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

      volumes:
      - name: config
        configMap:
          name: powerdns-config
          items:
          - key: pdns.conf
            path: pdns.conf
      - name: geoip-backend-script
        configMap:
          name: powerdns-config
          items:
          - key: geoip-backend.sh
            path: geoip-backend.sh
            mode: 0755
      - name: geoip-data
        persistentVolumeClaim:
          claimName: geoip-data

---
# Service for DNS (UDP/TCP)
apiVersion: v1
kind: Service
metadata:
  name: powerdns-dns
  namespace: powerdns-system
  labels:
    app: powerdns
spec:
  type: LoadBalancer
  ports:
  - port: 53
    targetPort: 53
    protocol: UDP
    name: dns-udp
  - port: 53
    targetPort: 53
    protocol: TCP
    name: dns-tcp
  selector:
    app: powerdns

---
# Service for API
apiVersion: v1
kind: Service
metadata:
  name: powerdns-api
  namespace: powerdns-system
  labels:
    app: powerdns
spec:
  type: ClusterIP
  ports:
  - port: 8081
    targetPort: 8081
    protocol: TCP
    name: api
  selector:
    app: powerdns
